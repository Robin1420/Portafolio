<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Datos Personales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Encabezado -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Gestión de Datos Personales</h1>
            <p class="text-gray-600">Administra tu información personal y profesional</p>
        </header>

        <!-- Botón para abrir el modal de creación -->
        <!-- Contenedor principal -->
        <div class="container mx-auto px-4 py-8">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Datos Personales</h1>
            </div>
            
            <!-- Tabla de datos (solo en pantallas medianas y grandes) -->
            <div class="hidden md:block bg-white shadow-md rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profesión</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contacto</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Documento</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaDatos" class="bg-white divide-y divide-gray-200">
                        <!-- Los datos se cargarán aquí dinámicamente -->
                    </tbody>
                </table>
            </div>
            
            <!-- Contenedor de tarjetas (solo en móviles) -->
            <div id="cardsContainer" class="md:hidden grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                <!-- Las tarjetas se cargarán aquí dinámicamente -->
            </div>
        </div>
    </div>


    <!-- Modal para previsualización de imagen o CV -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden">
            <!-- Encabezado del modal -->
            <div class="flex justify-between items-center p-4 border-b bg-black text-white">
                <h3 id="previewTitle" class="text-lg font-medium">Vista Previa</h3>
                <button onclick="closePreviewModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Contenido del modal -->
            <div id="previewContent" class="flex-1 overflow-auto p-4">
                <!-- La imagen o PDF se cargará aquí dinámicamente -->
            </div>
            
            <!-- Pie del modal con botones -->
            <div class="p-4 border-t flex justify-between items-center">
                <div id="fileInfo" class="text-sm text-gray-500">
                    <!-- Información del archivo se mostrará aquí -->
                </div>
                <div class="space-x-3">
                    <label class="cursor-pointer px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i> Cambiar
                        <input type="file" id="fileInput" class="hidden" accept="image/*,.pdf">
                    </label>
                    <a id="downloadBtn" href="#" download class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                        <i class="fas fa-download mr-2"></i> Descargar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar -->
    <div id="modalFormulario" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 flex">
        <div class="bg-white rounded-lg w-full max-w-2xl p-6 mx-4">
            <div class="flex justify-between items-center mb-4 bg-blue-500 text-white p-4 rounded-t-lg -m-6 mb-6">
                <h2 id="modalTitulo" class="text-xl font-bold">Editar Datos</h2>
                <button onclick="cerrarModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="formDatos" class="space-y-4">
                <input type="hidden" id="id" name="id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="nombre" name="nombre" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="profesion" class="block text-sm font-medium text-gray-700">Profesión</label>
                        <input type="text" id="profesion" name="profesion" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripción</label>
                        <textarea id="descripcion" name="descripcion" rows="3"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="email" name="email" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="telefono" class="block text-sm font-medium text-gray-700">Teléfono</label>
                        <input type="tel" id="telefono" name="telefono"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="direccion" class="block text-sm font-medium text-gray-700">Dirección</label>
                        <input type="text" id="direccion" name="direccion"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                   
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="cerrarModal()"
                        class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variable global para mantener el registro actual
        let registroActual = null;
        const API_URL = 'http://localhost:3000/api'; // URL base de la API

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM completamente cargado, iniciando carga de datos...');
            cargarDatos();
        });

        // Manejar el envío del formulario
        document.getElementById('formDatos').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const formData = new FormData(form);
            const id = formData.get('id');
            
            try {
                // Mostrar indicador de carga
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Procesando...
                `;
                
                // Crear objeto con los datos del formulario
                const datos = {};
                
                // Agregar solo los campos que tienen valor
                const campos = ['nombre', 'profesion', 'descripcion', 'email', 'telefono', 'direccion'];
                campos.forEach(campo => {
                    const valor = formData.get(campo);
                    if (valor !== null && valor !== '') {
                        datos[campo] = valor;
                    }
                });
                
                // Agregar el ID si existe (para actualización)
                if (id) {
                    datos.id = id;
                    console.log('ID del registro a actualizar:', id);
                } else {
                    console.log('Creando nuevo registro');
                }
                
                console.log('Datos a enviar:', datos);
                
                // Determinar si es una actualización o creación
                let resultado;
                if (id) {
                    resultado = await actualizarDatosPersonales(datos);
                } else {
                    const nuevoId = await crearDatosPersonales(datos);
                    resultado = { id: nuevoId };
                }
                
                console.log('Respuesta del servidor:', resultado);
                
                // Mostrar mensaje de éxito
                mostrarNotificacion(
                    id ? '¡Datos actualizados correctamente!' : '¡Datos guardados correctamente!',
                    'success'
                );
                
                // Cerrar el modal y recargar los datos
                cerrarModal();
                await cargarDatos();
                
            } catch (error) {
                console.error('Error al guardar los datos:', error);
                mostrarNotificacion(
                    `Error al ${id ? 'actualizar' : 'guardar'} los datos: ${error.message}`,
                    'error'
                );
            } finally {
                // Restaurar el botón de envío
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = id ? 'Actualizar' : 'Guardar';
                }
            }
        });
        

        // Función para mostrar notificaciones
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const tipos = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const notificacion = document.createElement('div');
            notificacion.className = `fixed top-4 right-4 text-white px-6 py-3 rounded-md shadow-lg ${tipos[tipo] || tipos.info} transition-all duration-300 transform translate-x-0 opacity-100`;
            notificacion.textContent = mensaje;
            
            document.body.appendChild(notificacion);
            
            // Eliminar la notificación después de 5 segundos
            setTimeout(() => {
                notificacion.style.transform = 'translateX(120%)';
                notificacion.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notificacion);
                }, 300);
            }, 5000);
        }

        // Función para cargar los datos en la tabla y tarjetas
        async function cargarDatos() {
            const tabla = document.getElementById('tablaDatos');
            const cardsContainer = document.getElementById('cardsContainer');
            let loader = null;
            
            if (!tabla && !cardsContainer) {
                console.error('No se encontró el contenedor de la tabla ni el de tarjetas');
                return;
            }
            
            // Función para eliminar el loader si existe
            const removeLoader = () => {
                if (loader && document.body.contains(loader)) {
                    document.body.removeChild(loader);
                    loader = null;
                }
            };
            
            try {
                // Mostrar indicador de carga
                loader = document.createElement('div');
                loader.id = 'data-loading-indicator';
                loader.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                loader.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow-lg">
                        <div class="flex items-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mr-3"></div>
                            <span class="text-gray-700">Cargando datos...</span>
                        </div>
                    </div>
                `;
                document.body.appendChild(loader);
                
                // Obtener los datos de la API
                const response = await fetch('/api/datos-personales');
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Limpiar la tabla y el contenedor de tarjetas
                if (tabla) tabla.innerHTML = '';
                if (cardsContainer) cardsContainer.innerHTML = '';
                
                if (!data || data.length === 0) {
                    // Mostrar mensaje de "sin datos"
                    if (tabla) {
                        const noDataRow = document.createElement('tr');
                        noDataRow.innerHTML = `
                            <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                No hay datos disponibles.
                            </td>
                        `;
                        tabla.appendChild(noDataRow);
                    }
                    
                    if (cardsContainer) {
                        const noDataCard = document.createElement('div');
                        noDataCard.className = 'col-span-2 bg-white p-4 rounded-lg shadow text-center text-gray-500';
                        noDataCard.textContent = 'No hay datos disponibles';
                        cardsContainer.appendChild(noDataCard);
                    }
                    
                    removeLoader();
                    return;
                }
                
                // Procesar cada registro
                data.forEach(registro => {
                    // Crear fila para la tabla
                    if (tabla) {
                        const row = document.createElement('tr');
                        
                        // Celda de nombre
                        const nombreCell = document.createElement('td');
                        nombreCell.className = 'px-6 py-4 whitespace-nowrap';
                        nombreCell.innerHTML = `
                            <div class="flex items-center">
                                <button onclick="openPreviewModal('../../file/datos/foto-personal.png', 'Foto de Perfil', 'image')" 
                                        class="focus:outline-none hover:opacity-90 transition-opacity">
                                    <img src="../../file/datos/foto-personal.png" alt="Foto de perfil" 
                                         class="h-10 w-10 rounded-full object-cover mr-3">
                                </button>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${registro.nombre || 'Sin nombre'}</div>
                                </div>
                            </div>
                        `;
                        
                        // Celda de profesión
                        const profesionCell = document.createElement('td');
                        profesionCell.className = 'px-6 py-4 whitespace-nowrap';
                        profesionCell.innerHTML = `
                            <div class="text-sm text-gray-900">${registro.profesion || 'No especificada'}</div>
                        `;
                        
                        // Celda de descripción
                        const descripcionCell = document.createElement('td');
                        descripcionCell.className = 'px-6 py-4 max-w-xs';
                        descripcionCell.innerHTML = `
                            <div class="text-sm text-gray-900" title="${registro.descripcion || ''}">
                                ${registro.descripcion || 'Sin descripción'}
                            </div>
                        `;
                        
                        // Celda de CV
                        const cvCell = document.createElement('td');
                        cvCell.className = 'px-6 py-4 whitespace-nowrap';
                        cvCell.innerHTML = `
                            <button onclick="openPreviewModal('/file/datos/cv-personal.pdf', 'Documento', 'pdf')" 
                                    class="text-blue-600 hover:text-blue-800 flex items-center focus:outline-none">
                                <i class="fas fa-file-pdf mr-2 text-red-500"></i>
                                Documento
                            </button>
                        `;
                        
                        // Celda de contacto (email, teléfono, dirección)
                        const contactoCell = document.createElement('td');
                        contactoCell.className = 'px-6 py-4 whitespace-normal';
                        contactoCell.innerHTML = `
                            <div class="space-y-1">
                                <div class="flex items-center">
                                    <i class="fas fa-envelope mr-2 text-gray-400 w-4"></i>
                                    <span class="text-sm text-gray-900">${registro.email || 'Sin email'}</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-phone mr-2 text-gray-400 w-4"></i>
                                    <span class="text-sm text-gray-900">${registro.telefono || 'Sin teléfono'}</span>
                                </div>
                                <div class="flex items-start">
                                    <i class="fas fa-map-marker-alt mt-1 mr-2 text-gray-400 w-4 flex-shrink-0"></i>
                                    <span class="text-sm text-gray-900">${registro.direccion || 'Sin dirección'}</span>
                                </div>
                            </div>
                        `;
                        
                        // Celda de acciones
                        const accionesCell = document.createElement('td');
                        accionesCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
                        accionesCell.innerHTML = `
                            <button onclick="editarRegistro(${JSON.stringify(registro).replace(/"/g, '&quot;')})" 
                                    class="text-blue-600 hover:text-blue-900">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        `;
                        
                        // Agregar celdas a la fila
                        row.appendChild(nombreCell);
                        row.appendChild(profesionCell);
                        row.appendChild(descripcionCell);
                        row.appendChild(contactoCell);
                        row.appendChild(cvCell);
                        row.appendChild(accionesCell);
                        
                        // Agregar fila a la tabla
                        tabla.appendChild(row);
                    }
                    
                    // Crear tarjeta para móviles
                    if (cardsContainer) {
                        const card = document.createElement('div');
                        card.className = 'bg-white overflow-hidden shadow rounded-lg';
                        card.innerHTML = `
                            <div class="p-4">
                                <div class="flex items-start">
                                    <button onclick="openPreviewModal('/file/datos/foto-personal.png', 'Foto de Perfil', 'image')" 
                                            class="focus:outline-none hover:opacity-90 transition-opacity">
                                        <img src="/file/datos/foto-personal.png" alt="Foto de perfil" 
                                             class="h-12 w-12 rounded-full object-cover mr-3 flex-shrink-0">
                                    </button>
                                    <div class="flex-1">
                                        <h3 class="text-lg font-medium text-gray-900">${registro.nombre || 'Sin nombre'}</h3>
                                        <p class="text-sm text-gray-500 mb-2">${registro.profesion || 'No especificada'}</p>
                                        <div class="text-sm text-gray-700 space-y-1">
                                            <p class="flex items-center">
                                                <i class="fas fa-envelope w-4 text-gray-500 mr-2"></i>
                                                <span>${registro.email || 'Sin email'}</span>
                                            </p>
                                            <p class="flex items-center">
                                                <i class="fas fa-phone w-4 text-gray-500 mr-2"></i>
                                                <span>${registro.telefono || 'Sin teléfono'}</span>
                                            </p>
                                            <p class="flex items-start">
                                                <i class="fas fa-map-marker-alt mt-0.5 w-4 text-gray-500 mr-2 flex-shrink-0"></i>
                                                <span>${registro.direccion || 'Sin dirección'}</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                    <button onclick="openPreviewModal('/file/datos/cv-personal.pdf', 'Documento', 'pdf')" 
                                            class="text-blue-600 hover:text-blue-800 text-sm flex items-center focus:outline-none">
                                        <i class="fas fa-file-pdf mr-1 text-red-500"></i>
                                        Ver CV
                                    </button>
                                    <div class="space-x-3">
                                        <button onclick="editarRegistro(${JSON.stringify(registro).replace(/"/g, '&quot;')})" 
                                                class="text-blue-600 hover:text-blue-900 text-sm">
                                            <i class="fas fa-edit mr-1"></i> Editar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        cardsContainer.appendChild(card);
                    }
                });
                
            } catch (error) {
                console.error('Error al cargar los datos:', error);
                
                // Mostrar mensaje de error
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-50 border-l-4 border-red-400 p-4 mb-4';
                errorDiv.role = 'alert';
                errorDiv.innerHTML = `
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-red-700">
                                No se pudieron cargar los datos. Por favor, intente recargar la página.
                                <br>
                                <small>Error: ${error.message}</small>
                            </p>
                        </div>
                    </div>
                `;
                
                // Insertar el mensaje de error al principio del contenedor
                const errorContainer = document.querySelector('.container.mx-auto.px-4.py-8');
                if (errorContainer) {
                    errorContainer.insertBefore(errorDiv, errorContainer.firstChild);
                }
            } finally {
                // Asegurarse de que el loader se elimine en cualquier caso
                removeLoader();
            }
        }

        // Variables para el modal de previsualización
        let currentFileType = ''; // 'image' o 'pdf'
        let currentFileUrl = '';
        
        // Cerrar el modal al hacer clic fuera del contenido
        document.getElementById('previewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePreviewModal();
            }
        });
        
        // Cerrar con la tecla Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && !document.getElementById('previewModal').classList.contains('hidden')) {
                closePreviewModal();
            }
        });
        
        // Función para abrir el modal de previsualización
        function openPreviewModal(fileUrl, title, fileType) {
            const modal = document.getElementById('previewModal');
            const previewContent = document.getElementById('previewContent');
            const previewTitle = document.getElementById('previewTitle');
            const downloadBtn = document.getElementById('downloadBtn');
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            
            // Configurar el tipo de archivo y URL actual
            currentFileType = fileType;
            currentFileUrl = fileUrl;
            
            // Configurar el título
            previewTitle.textContent = title;
            
            // Configurar el botón de descarga
            downloadBtn.href = fileUrl;
            downloadBtn.download = fileUrl.split('/').pop();
            
            // Limpiar contenido previo
            previewContent.innerHTML = '';
            
            // Mostrar el contenido según el tipo de archivo
            if (fileType === 'image') {
                const img = document.createElement('img');
                img.src = fileUrl;
                img.alt = 'Vista previa de la imagen';
                img.className = 'max-w-full max-h-[70vh] mx-auto';
                previewContent.appendChild(img);
                fileInput.accept = 'image/*';
                fileInfo.textContent = 'Formato: Imagen';
            } else if (fileType === 'pdf') {
                const embed = document.createElement('embed');
                embed.src = fileUrl + '#toolbar=0&navpanes=0&scrollbar=0';
                embed.type = 'application/pdf';
                embed.className = 'w-full h-[70vh] border';
                previewContent.appendChild(embed);
                fileInput.accept = '.pdf';
                fileInfo.textContent = 'Formato: PDF';
            }
            
            // Configurar el input de archivo
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Validar el tipo de archivo
                if ((fileType === 'image' && !file.type.startsWith('image/')) || 
                    (fileType === 'pdf' && file.type !== 'application/pdf')) {
                    alert(`Por favor, seleccione un archivo de tipo ${fileType.toUpperCase()}`);
                    return;
                }
                
                // Aquí puedes agregar la lógica para subir el archivo al servidor
                // Por ahora, solo actualizamos la vista previa
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (fileType === 'image') {
                        const img = previewContent.querySelector('img');
                        img.src = e.target.result;
                        downloadBtn.href = e.target.result;
                        downloadBtn.download = file.name;
                    } else {
                        const embed = previewContent.querySelector('embed');
                        embed.src = URL.createObjectURL(file) + '#toolbar=0&navpanes=0&scrollbar=0';
                        downloadBtn.href = URL.createObjectURL(file);
                        downloadBtn.download = file.name;
                    }
                    fileInfo.textContent = `Archivo: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                };
                
                if (fileType === 'image') {
                    reader.readAsDataURL(file);
                } else {
                    // Para PDF, usamos URL.createObjectURL directamente
                    fileInfo.textContent = `Archivo: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                }
            };
            
            // Mostrar el modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('overflow-hidden');
            
            // Enfocar el modal para accesibilidad
            modal.setAttribute('aria-hidden', 'false');
        }
        
        // Función para cerrar el modal de previsualización
        function closePreviewModal() {
            const modal = document.getElementById('previewModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('overflow-hidden');
            modal.setAttribute('aria-hidden', 'true');
        }

        // Función para editar un registro
        async function editarRegistro(registro) {
            try {
                console.log('Editando registro:', registro);
                registroActual = registro;
                
                // Actualizar el título del modal
                document.getElementById('modalTitulo').textContent = 'Editar Datos';
                
                // Obtener el formulario y limpiarlo
                const form = document.getElementById('formDatos');
                form.reset();
                
                // Establecer los valores del formulario
                if (registro.id) {
                    document.getElementById('id').value = registro.id;
                    console.log('ID establecido en el formulario:', document.getElementById('id').value);
                }
                
                // Establecer los demás campos
                const campos = ['nombre', 'profesion', 'descripcion', 'email', 'telefono', 'direccion'];
                campos.forEach(campo => {
                    if (registro[campo] !== undefined) {
                        const element = document.getElementById(campo);
                        if (element) {
                            element.value = registro[campo];
                        }
                    }
                });
                
                // Mostrar el modal
                document.getElementById('modalFormulario').classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                
                // Enfocar el primer campo del formulario
                setTimeout(() => {
                    const firstInput = form.querySelector('input:not([type="hidden"]), textarea');
                    if (firstInput) firstInput.focus();
                }, 100);
                
            } catch (error) {
                console.error('Error al cargar los datos para editar:', error);
                mostrarNotificacion('Error al cargar los datos para editar', 'error');
            }
        }

        function cerrarModal() {
            document.getElementById('modalFormulario').classList.add('hidden');
            document.getElementById('modalFormulario').classList.remove('flex');
        }

        function solicitarEliminar(id) {
            registroActual = { id };
            document.getElementById('modalEliminar').classList.remove('hidden');
            document.getElementById('modalEliminar').classList.add('flex');
        }

        function cerrarModalEliminar() {
            document.getElementById('modalEliminar').classList.add('hidden');
            document.getElementById('modalEliminar').classList.remove('flex');
        }

        // Configurar el botón de confirmar eliminación
        document.getElementById('confirmarEliminar').addEventListener('click', async () => {
            if (registroActual && registroActual.id) {
                try {
                    await eliminarDatosPersonales(registroActual.id);
                    await cargarDatos();
                    cerrarModalEliminar();
                } catch (error) {
                    console.error('Error al eliminar el registro:', error);
                    alert('Error al eliminar el registro. Por favor, intente nuevamente.');
                }
            }
        });

        // Funciones para interactuar con la API
        async function crearDatosPersonales(datos) {
            try {
                console.log('Creando nuevo registro en:', `${API_URL}/datos-personales`);
                console.log('Datos a enviar:', datos);
                
                const response = await fetch(`${API_URL}/datos-personales`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(datos)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al crear el registro');
                }

                const resultado = await response.json();
                return resultado.id;
            } catch (error) {
                console.error('Error al crear datos personales:', error);
                throw error;
            }
        }

        async function actualizarDatosPersonales(datos) {
            try {
                console.log('Enviando datos para actualizar:', datos);
                const id = datos.id;
                if (!id) {
                    throw new Error('ID de registro no proporcionado');
                }
                
                // Crear una copia de los datos para no modificar el original
                const datosParaEnviar = { ...datos };
                delete datosParaEnviar.id; // Eliminar el ID del objeto de datos
                
                const url = `${API_URL}/datos-personales/${id}`;
                console.log('URL de actualización:', url);
                console.log('Datos a enviar:', datosParaEnviar);
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(datosParaEnviar)
                });

                const responseData = await response.json();
                
                if (!response.ok) {
                    console.error('Error en la respuesta del servidor:', responseData);
                    throw new Error(responseData.error || 'Error al actualizar el registro');
                }

                console.log('Actualización exitosa:', responseData);
                return responseData;
            } catch (error) {
                console.error('Error al actualizar datos personales:', {
                    error: error.message,
                    stack: error.stack,
                    datos: datos
                });
                throw error;
            }
        }

        async function eliminarDatosPersonales(id) {
            try {
                const response = await fetch(`${API_URL}/datos-personales/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al eliminar el registro');
                }

                return true;
            } catch (error) {
                console.error('Error al eliminar datos personales:', error);
                throw error;
            }
        }

        // Función auxiliar para convertir archivos a base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Mostrar vista previa de la imagen si es una imagen
                    if (file.type.startsWith('image/')) {
                        const imgPreview = document.createElement('img');
                        imgPreview.id = 'foto_preview';
                        imgPreview.src = reader.result;
                        imgPreview.className = 'mt-2 h-20 w-20 object-cover rounded-full';
                        
                        // Reemplazar la vista previa anterior si existe
                        const existingPreview = document.getElementById('foto_preview');
                        const fotoContainer = document.getElementById('foto_perfil').parentNode;
                        
                        if (existingPreview) {
                            existingPreview.src = reader.result;
                        } else {
                            fotoContainer.appendChild(imgPreview);
                        }
                    }
                    resolve(reader.result);
                };
                reader.onerror = error => reject(error);
            });
        }

        // Funciones para mostrar/ocultar indicador de carga
        function showLoader(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            let loader = modal.querySelector('.loader');
            if (!loader) {
                loader = document.createElement('div');
                loader.className = 'loader absolute inset-0 flex items-center justify-center bg-black bg-opacity-70 z-10';
                loader.innerHTML = `
                    <div class="text-white flex flex-col items-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-2"></div>
                        <span>Cargando...</span>
                    </div>
                `;
                modal.querySelector('.modal-content').appendChild(loader);
            }
            loader.style.display = 'flex';
        }

        function hideLoader(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            const loader = modal.querySelector('.loader');
            if (loader) {
                loader.style.display = 'none';
            }
        }

        // Función para verificar si una imagen existe
        function checkImageExists(imageUrl, callback) {
            const img = new Image();
            img.onload = function() { callback(true); };
            img.onerror = function() { callback(false); };
            img.src = imageUrl;
        }

        // Función para manejar la carga de imágenes
        function handleImageLoad(img) {
            // Verificar si la imagen se cargó correctamente
            if (img.complete && img.naturalWidth === 0) {
                // Si la imagen no se cargó correctamente
                img.onerror();
            }
        }
    </script>

    <!-- Estilos mejorados para los modales -->
    <style>
        /* Estilos base del modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .modal-header {
            background-color: #3b82f6;
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-img {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
        }
        
        .modal-pdf {
            width: 100%;
            height: 70vh;
            border: none;
        }
        
        .modal-footer {
            padding: 12px 20px;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal-content {
            position: relative;
            background-color: #fff;
            margin: auto;
            padding: 0;
            width: 90%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal.show .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            background-color: #3b82f6;
            color: white;
            padding: 1rem 1.5rem;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        /* Estilos para la imagen en el modal */
        .modal-img-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            background-color: #f8f9fa;
            min-height: 300px;
            position: relative;
            overflow: hidden;
        }
        
        .modal-pdf-container {
            flex: 1;
            min-height: 60vh;
            background-color: #525659;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-pdf {
            width: 100%;
            height: 100%;
            min-height: 60vh;
            border: none;
            background-color: #525659;
        }
        
        /* Estilos para el indicador de carga */
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            gap: 1rem;
            z-index: 10;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4f46e5;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .modal-img {
            max-width: 100%;
            max-height: 70vh;
            width: auto;
            height: auto;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
            background-color: #fff;
        }
        
        .modal-img:hover {
            transform: scale(1.02);
        }
        
        /* Encabezado del modal */
        .modal-header {
            padding: 1rem 1.5rem;
            background-color: #2d3748;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
        }
        
        /* Botón de cierre */
        .close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            transition: all 0.3s ease;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
            outline: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .close-btn:hover, .close-btn:focus {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
        
        .close-btn:active {
            transform: rotate(90deg) scale(0.95);
        }
        
        /* Pie del modal */
        .modal-footer {
            padding: 1rem 1.5rem;
            background-color: #f8f9fa;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .modal-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .btn-download {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 0.5rem 1.25rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .btn-download:hover {
            background: linear-gradient(135deg, #4338ca, #6d28d9);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-download:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .btn-download i {
            font-size: 0.9em;
        }
        
        /* Mensaje de ayuda */
        .help-text {
            color: #6b7280;
            font-size: 0.875rem;
            margin: 0;
            flex: 1;
            text-align: right;
        }
        
        /* Efecto de carga */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .spinner {
            width: 1.5rem;
            height: 1.5rem;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-left-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-height: 95vh;
            }
            
            .modal-footer {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            
            .help-text {
                text-align: center;
                margin-top: 0.5rem;
            }
        }
    </style>

    <!-- Modal para la foto -->
    <div id="fotoModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="fotoModalTitle" aria-describedby="fotoModalDesc">
        <div class="modal-content" role="document">
            <div class="flex justify-between items-center mb-4 bg-blue-500 text-white p-4 rounded-t-lg -m-6 mb-6">
                <h3 id="fotoModalTitle" class="text-xl font-bold">Vista Previa de la Foto</h3>
                <button onclick="closeModal('fotoModal')" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="modal-img-container">
                <img id="modalFoto" class="modal-img" src="" alt="Foto de perfil" onload="hideLoader('foto')">
                <div class="loading" id="fotoLoading" role="status" aria-live="polite">
                    <div class="spinner" aria-hidden="true"></div>
                    <span>Cargando imagen...</span>
                </div>
            </div>
            <div class="modal-footer">
                <p id="fotoModalDesc" class="help-text">Puedes descargar la imagen o cerrar esta ventana</p>
                <div class="modal-actions">
                    <a id="downloadFotoBtn" href="#" class="btn-download" aria-label="Descargar foto">
                        <i class="fas fa-download" aria-hidden="true"></i> Descargar
                    </a>
                    <button onclick="closeModal('fotoModal')" class="btn-download" style="background: #6b7280;" aria-label="Cerrar ventana de vista previa">
                        <i class="fas fa-times" aria-hidden="true"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para el CV -->
    <div id="cvModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="cvModalTitle" aria-describedby="cvModalDesc">
        <div class="modal-content" role="document">
            <div class="flex justify-between items-center mb-4 bg-blue-500 text-white p-4 rounded-t-lg -m-6 mb-6">
                <h3 id="cvModalTitle" class="text-xl font-bold">Visualizador de CV</h3>
                <button onclick="closeModal('cvModal')" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="modal-pdf-container">
                <iframe 
                    id="modalCVPdf" 
                    class="modal-pdf" 
                    src="" 
                    title="Vista previa del CV"
                    aria-label="Vista previa del documento PDF"
                    onload="hideLoader('cv')">
                </iframe>
                <div class="loading" id="cvLoading" role="status" aria-live="polite">
                    <div class="spinner" aria-hidden="true"></div>
                    <span>Cargando documento...</span>
                </div>
            </div>
            <div class="modal-footer">
                <p id="cvModalDesc" class="help-text">Si el documento no se carga correctamente, intenta descargarlo</p>
                <div class="modal-actions">
                    <a id="downloadCvBtn" href="#" class="btn-download" aria-label="Descargar CV">
                        <i class="fas fa-download" aria-hidden="true"></i> Descargar
                    </a>
                    <button onclick="closeModal('cvModal')" class="btn-download" style="background: #6b7280;" aria-label="Cerrar visualizador de CV">
                        <i class="fas fa-times" aria-hidden="true"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Función para mostrar el indicador de carga
        function showLoader(modalId) {
            const loader = document.getElementById(`${modalId}Loading`);
            if (loader) {
                loader.style.display = 'flex';
            }
        }

        // Función para ocultar el indicador de carga
        function hideLoader(modalId) {
            const loader = document.getElementById(`${modalId}Loading`);
            if (loader) {
                loader.style.display = 'none';
            }
        }
        
        // Variable para mantener el último elemento con foco antes de abrir el modal
        let lastFocusedElement = null;
        
        // Función para atrapar el foco dentro del modal
        function trapFocus(element) {
            const focusableElements = element.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            
            if (focusableElements.length === 0) return;
            
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];
            
            // Mover el foco al primer elemento enfocable
            firstFocusable.focus();
            
            // Manejar el tab para mantener el foco dentro del modal
            element.addEventListener('keydown', function(e) {
                const isTabPressed = (e.key === 'Tab' || e.keyCode === 9);
                
                if (!isTabPressed) return;
                
                if (e.shiftKey) {
                    // Shift + Tab
                    if (document.activeElement === firstFocusable) {
                        e.preventDefault();
                        lastFocusable.focus();
                    }
                } else {
                    // Solo Tab
                    if (document.activeElement === lastFocusable) {
                        e.preventDefault();
                        firstFocusable.focus();
                    }
                }
            });
        }
        
        // Función para abrir el modal de la foto
        function openFotoModal(fotoUrl) {
            const modal = document.getElementById('fotoModal');
            const img = document.getElementById('modalFoto');
            const downloadBtn = document.getElementById('downloadFotoBtn');
            
            if (!modal || !img || !downloadBtn) return;
            
            // Guardar el elemento que tenía el foco
            lastFocusedElement = document.activeElement;
            
            // Mostrar el indicador de carga
            showLoader('foto');
            
            // Configurar la URL con un timestamp para evitar caché
            const imgUrl = fotoUrl + '?t=' + new Date().getTime();
            
            // Configurar el botón de descarga
            downloadBtn.href = imgUrl;
            downloadBtn.download = 'foto-perfil.jpg';
            downloadBtn.setAttribute('aria-label', 'Descargar foto de perfil');
            
            // Configurar la imagen
            img.onload = function() {
                hideLoader('foto');
                // Actualizar el nombre del archivo de descarga con el ID si está disponible
                const idMatch = fotoUrl.match(/\/(\d+)\/foto/);
                if (idMatch && idMatch[1]) {
                    downloadBtn.download = `foto-perfil-${idMatch[1]}.jpg`;
                }
            };
            
            img.onerror = function() {
                hideLoader('foto');
                // Mostrar mensaje de error accesible
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                errorMsg.textContent = 'No se pudo cargar la imagen. Por favor, inténtalo de nuevo.';
                errorMsg.setAttribute('role', 'alert');
                errorMsg.setAttribute('aria-live', 'assertive');
                modal.querySelector('.modal-img-container').appendChild(errorMsg);
                
                // Deshabilitar el botón de descarga si hay un error
                downloadBtn.style.opacity = '0.6';
                downloadBtn.style.cursor = 'not-allowed';
                downloadBtn.onclick = (e) => e.preventDefault();
            };
            
            // Establecer la fuente de la imagen
            img.src = imgUrl;
            
            // Mostrar el modal
            modal.style.display = 'flex';
            
            // Agregar la clase active después de un pequeño retraso para la animación
            setTimeout(() => {
                modal.classList.add('active');
                // Atrapar el foco dentro del modal
                trapFocus(modal);
                
                // Agregar clase al body para evitar el desplazamiento
                document.body.style.overflow = 'hidden';
            }, 10);
            
            // Cerrar al hacer clic fuera del contenido
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeModal('fotoModal');
                }
            };
            // Cerrar con la tecla ESC
            const closeOnEsc = function(event) {
                if (event.key === 'Escape') {
                    closeModal('fotoModal');
                    document.removeEventListener('keydown', closeOnEsc);
                }
            };
            
            document.addEventListener('keydown', closeOnEsc);
        }
        
        // Función para abrir el modal del CV
        function openCVModal(cvUrl) {
            const modal = document.getElementById('cvModal');
            if (!modal) return; // Si no existe el modal, salir de la función
            
            const pdfViewer = document.getElementById('modalCVPdf');
            const downloadBtn = document.getElementById('downloadCvBtn');
            const closeButton = modal.querySelector('button[onclick*="closeModal"]');
            
            // Guardar el último elemento con foco
            lastFocusedElement = document.activeElement;
            
            // Mostrar el indicador de carga
            showLoader('cv');
            
            // Configurar la URL del visor de PDF (sin parámetro de descarga para visualización)
            const viewPdfUrl = cvUrl + (cvUrl.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
            
            // Configurar la URL de descarga (con parámetro download=true)
            const downloadPdfUrl = cvUrl + (cvUrl.includes('?') ? '&' : '?') + 'download=true&t=' + new Date().getTime();
            
            // Configurar el visor de PDF
            pdfViewer.onload = function() {
                hideLoader('cv');
                // Enfocar el botón de cierre una vez que el PDF se cargue
                if (closeButton) closeButton.focus();
            };
            
            pdfViewer.onerror = function() {
                hideLoader('cv');
                // Mostrar mensaje de error accesible
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                errorMsg.textContent = 'No se pudo cargar el documento PDF. Por favor, inténtalo de nuevo o utiliza el botón de descarga.';
                errorMsg.setAttribute('role', 'alert');
                errorMsg.setAttribute('aria-live', 'assertive');
                modal.querySelector('.modal-pdf-container').appendChild(errorMsg);
                
                // Enfocar el botón de cierre en caso de error
                closeButton.focus();
            };
            
            // Configurar el visor de PDF
            pdfViewer.src = viewPdfUrl;
            
            // Configurar el botón de descarga
            downloadBtn.href = downloadPdfUrl;
            downloadBtn.setAttribute('download', ''); // Forzar descarga
            
            // Mostrar el modal
            modal.style.display = 'flex';
            
            // Agregar la clase active después de un pequeño retraso para la animación
            setTimeout(() => {
                modal.classList.add('active');
                // Atrapar el foco dentro del modal
                trapFocus(modal);
                
                // Agregar clase al body para evitar el desplazamiento
                document.body.style.overflow = 'hidden';
            }, 10);
            
            // Cerrar al hacer clic fuera del contenido
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeModal('cvModal');
                }
            };
            
            // Cerrar con la tecla ESC
            const closeOnEsc = function(event) {
                if (event.key === 'Escape') {
                    closeModal('cvModal');
                    document.removeEventListener('keydown', closeOnEsc);
                }
            };
            
            document.addEventListener('keydown', closeOnEsc);
        }
        
        // Función para cerrar el modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            // Restaurar el desplazamiento del body
            document.body.style.overflow = '';
            
            // Eliminar la clase active para la animación de salida
            modal.classList.remove('active');
            
            // Limpiar el contenido del modal
            if (modalId === 'fotoModal') {
                const img = modal.querySelector('img');
                const downloadBtn = document.getElementById('downloadFotoBtn');
                
                if (img) {
                    // Limpiar manejadores de eventos de la imagen
                    img.onload = null;
                    img.onerror = null;
                    // Limpiar la fuente de la imagen para liberar memoria
                    img.src = '';
                    img.alt = '';
                    // Forzar la recolección de basura (opcional)
                    if (window.gc) window.gc();
                }
                
                // Restablecer el botón de descarga
                if (downloadBtn) {
                    downloadBtn.style.opacity = '';
                    downloadBtn.style.cursor = '';
                    downloadBtn.onclick = null;
                }
                
            } else if (modalId === 'cvModal') {
                const iframe = modal.querySelector('iframe');
                if (iframe) {
                    // Limpiar la fuente del iframe
                    iframe.src = 'about:blank';
                }
            }
            
            // Limpiar cualquier mensaje de error
            const errorMessages = modal.querySelectorAll('.error-message');
            errorMessages.forEach(msg => msg.remove());
            
            // Eliminar cualquier manejador de eventos de teclado
            const closeOnEsc = function() {};
            document.removeEventListener('keydown', closeOnEsc);
            
            // Eliminar el manejador de clic fuera del contenido
            modal.onclick = null;
            
            // Esperar a que termine la animación antes de ocultar el modal
            setTimeout(() => {
                modal.style.display = 'none';
                
                // Restaurar el foco al último elemento que lo tenía
                if (lastFocusedElement) {
                    lastFocusedElement.focus();
                }
            }, 300); // Tiempo igual a la duración de la transición CSS
        }
    </script>
</body>
</html>